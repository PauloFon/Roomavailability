<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Availability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        button, select, input {
            transition: all 0.2s ease-in-out;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        @media (max-width: 640px) {
            .filter {
                flex-direction: column;
                gap: 1rem;
            }
            .filter div {
                width: 100%;
            }
        }
        #filterBtn, #resetBtn {
            background-color: #ed2025;
            color: white;
        }
        #filterBtn:hover, #resetBtn:hover {
            background-color: #c9181e;
        }
        #enBtn, #ptBtn {
            /* Styles for language buttons will be handled by JS */
        }
        #maxPrice {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        #maxPrice:focus {
            outline: none;
            ring: 2px;
            ring-color: #3b82f6;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <img src="https://quartoequartos.com/wp-content/uploads/2021/03/logo-sm.jpg" alt="Logo" class="h-20 w-30 rounded-md shadow" />
            <h1 id="mainTitle" class="text-2xl sm:text-3xl font-bold text-gray-800">Room Availability Filter</h1>
            <div class="lang-toggle mt-3 sm:mt-0">
                <button id="enBtn" onclick="toggleLanguage('en')" class="px-3 py-1 text-sm font-medium rounded-md"></button>
                <button id="ptBtn" onclick="toggleLanguage('pt')" class="px-3 py-1 text-sm font-medium rounded-md"></button>
            </div>
        </div>
        <div class="filter bg-white p-4 rounded-lg shadow-md mb-6">
            <div id="filterLabels" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end">
                <div class="flex flex-col">
                    <label id="monthLabel" for="month" class="text-sm font-medium text-gray-600 mb-1">Select Month:</label>
                    <select id="month" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </select>
                </div>
                <div class="flex flex-col">
                    <label id="balconyLabel" for="balcony" class="text-sm font-medium text-gray-600 mb-1">Balcony:</label>
                    <select id="balcony" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </select>
                </div>
                <div class="flex flex-col">
                    <label id="windowLabel" for="window" class="text-sm font-medium text-gray-600 mb-1">Window:</label>
                    <select id="window" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </select>
                </div>
                <div class="flex flex-col">
                    <label id="privatewcLabel" for="privatewc" class="text-sm font-medium text-gray-600 mb-1">Private WC:</label>
                    <select id="privatewc" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </select>
                </div>
                <div class="flex flex-col">
                    <label id="priceLabel" for="maxPrice" class="text-sm font-medium text-gray-600 mb-1">Max Price (€):</label>
                    <input type="number" id="maxPrice" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" min="0" step="1" value="1000">
                </div>
                <div class="flex flex-col sm:flex-row gap-2 lg:col-span-1 justify-end">
                    <button id="filterBtn" onclick="filterData()" class="w-full sm:w-auto bg-[#ed2025] text-white font-semibold py-2 px-4 rounded-md hover:bg-[#c9181e] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#ed2025]">Filter</button>
                    <button id="resetBtn" onclick="resetFilters()" class="w-full sm:w-auto bg-[#ed2025] text-white font-semibold py-2 px-4 rounded-md hover:bg-[#c9181e] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#ed2025]">Reset</button>
                </div>
            </div>
        </div>
        
        <div id="resultsCount" class="text-lg font-semibold mb-4 text-gray-700"></div>

        <div id="messageArea" class="my-4"></div>
        <div id="houseGrid" class="card-grid">
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let lang = 'en';
        let maxPriceDefault = 1000;

        // --- THIS IS THE CORRECTED LINE ---
        const monthsInOrder = ["JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO", "JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO"];

        const labels = {
            en: {
                mainTitle: "Room Availability",
                monthLabel: "Select Month:",
                balconyLabel: "Balcony:",
                windowLabel: "Window:",
                privatewcLabel: "Private WC:",
                priceLabel: "Max Price (€):",
                filterBtn: "Filter",
                resetBtn: "Reset",
                photos: "Photos",
                house: "House",
                address: "Address",
                room: "Room #",
                maxGuests: "Max Guests",
                balcony: "Balcony",
                window: "Window",
                privatewc: "Private WC",
                monthlyStatus: "Price / Month",
                loading: "Connecting with database...",
                noData: "Sorry! No Rooms Available.",
                resultsFound: "Showing {count} matching rooms",
                error: "Error loading data",
                viewPhoto: "View Photo",
                any: "Any",
                yes: "Yes",
                no: "No",
                months: { "JULHO": "July", "AGOSTO": "August", "SETEMBRO": "September", "OUTUBRO": "October", "NOVEMBRO": "November", "DEZEMBRO": "December", "JANEIRO": "January", "FEVEREIRO": "February", "MARÇO": "March", "ABRIL": "April", "MAIO": "May", "JUNHO": "June" }
            },
            pt: {
                mainTitle: "Disponibilidade de Quartos",
                monthLabel: "Selecione Mês:",
                balconyLabel: "Varanda:",
                windowLabel: "Janela:",
                privatewcLabel: "WC Privado:",
                priceLabel: "Preço Máximo (€):",
                filterBtn: "Filtrar",
                resetBtn: "Repor",
                photos: "Fotos",
                house: "Casa",
                address: "Morada",
                room: "Quarto #",
                maxGuests: "Máx Ocupação",
                balcony: "Varanda",
                window: "Janela",
                privatewc: "WC Privado",
                monthlyStatus: "Preço / Mês",
                loading: "Carregando dados da Folha Google...",
                noData: "Nenhum quarto corresponde aos seus critérios.",
                resultsFound: "Mostrando {count} quartos correspondentes",
                error: "Erro ao carregar dados",
                viewPhoto: "Ver Foto",
                any: "Qualquer",
                yes: "Sim",
                no: "Não",
                months: { "JULHO": "Julho", "AGOSTO": "Agosto", "SETEMBRO": "Setembro", "OUTUBRO": "Outubro", "NOVEMBRO": "Novembro", "DEZEMBRO": "Dezembro", "JANEIRO": "Janeiro", "FEVEREIRO": "Fevereiro", "MARÇO": "Março", "ABRIL": "Abril", "MAIO": "Maio", "JUNHO": "Junho" }
            }
        };

        function isAvailable(monthValue) {
            const isAvailableString = monthValue === 'Livre';
            const isAvailableNumber = typeof monthValue === 'number' && monthValue > 0;
            const isAvailableStringNumber = typeof monthValue === 'string' && !isNaN(parseFloat(monthValue)) && parseFloat(monthValue) > 0;
            return isAvailableString || isAvailableNumber || isAvailableStringNumber;
        }

        function computeStartMonth(availability) {
            for (let i = 0; i < monthsInOrder.length; i++) {
                let isGood = true;
                for (let j = i; j < monthsInOrder.length; j++) {
                    const m = monthsInOrder[j];
                    if (!isAvailable(availability[m])) {
                        isGood = false;
                        break;
                    }
                }
                if (isGood) {
                    return monthsInOrder[i];
                }
            }
            return null;
        }

        async function fetchData() {
            const url = 'https://script.google.com/macros/s/AKfycbwL2gJ0mzG7ch6SQzkwZUQ6chQb4kDQEupUEZR2L7iqQozrEkLEclEewqBXC-b25Yai_g/exec';
            if (!url.startsWith('https://script.google.com')) {
                showMessage('Error: Please paste your valid Google Apps Script URL into the `fetchData` function in the script.', 'error');
                return;
            }
            showMessage(labels[lang].loading, 'loading');
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Network response was not ok. Status: ${response.status}`);
                }
                const result = await response.json();
                if (result.error) {
                    throw new Error(`Google Script Error: ${result.error}. Details: ${result.details || ''}`);
                }
                // Validate and clean data
                allData = result.map(item => {
                    // Trim spaces from keys in availability object
                    const cleanedAvailability = {};
                    if (item.availability) {
                        for (const key in item.availability) {
                            cleanedAvailability[key.trim()] = item.availability[key];
                        }
                    }

                    const cleanedItem = {
                        ...item,
                        availability: cleanedAvailability,
                        privatewc: item.privatewc ?? 'NÃO',
                        balcony: item.balcony ?? 'NÃO',
                        window: item.window ?? 'NÃO',
                        price: item.price ?? null
                    };
                    cleanedItem.startMonth = computeStartMonth(cleanedItem.availability || {});
                    return cleanedItem;
                });

                filteredData = [...allData];
                updatePriceRange();
                hideMessage();
                displayData(filteredData);
            } catch (error) {
                console.error('Fetch Error:', error);
                showMessage(`${labels[lang].error}: ${error.message}. Please check the console (F12) for more details. Ensure the Google Sheet is public or the script is deployed to be accessible by 'Anyone'.`, 'error');
                document.getElementById('houseGrid').innerHTML = `<div class="text-center p-8 text-red-500">${error.message}</div>`;
            }
        }

        function updatePriceRange() {
            const maxPriceInput = document.getElementById('maxPrice');
            const maxPrice = allData.reduce((max, item) => {
                const price = parseFloat(item.price);
                return !isNaN(price) && price > max ? price : max;
            }, maxPriceDefault);
            maxPriceInput.value = maxPrice.toFixed(0);
        }

        function filterData() {
            const balcony = document.getElementById('balcony').value;
            const windowVal = document.getElementById('window').value;
            const privatewc = document.getElementById('privatewc').value;
            const month = document.getElementById('month').value;
            const maxPriceInput = document.getElementById('maxPrice');
            const maxPrice = maxPriceInput.value === '' || isNaN(parseFloat(maxPriceInput.value)) || parseFloat(maxPriceInput.value) < 0 ? Infinity : parseFloat(maxPriceInput.value);

            filteredData = allData.filter(item => {
                const balconyMatch = balcony === '' || item.balcony === balcony;
                const windowMatch = windowVal === '' || item.window === windowVal;
                const privatewcMatch = privatewc === '' || item.privatewc === privatewc;
                const priceMatch = !item.price || isNaN(parseFloat(item.price)) || parseFloat(item.price) <= maxPrice;

                let monthMatch;
                if (month === '') {
                    monthMatch = item.startMonth !== null;
                } else {
                    // Check if the room is available for all months from the selected month onward
                    const startIndex = monthsInOrder.indexOf(month);
                    if (startIndex === -1) return false; // Invalid month
                    let isAvailableFromMonth = true;
                    for (let i = startIndex; i < monthsInOrder.length; i++) {
                        const m = monthsInOrder[i];
                        if (!isAvailable(item.availability[m])) {
                            isAvailableFromMonth = false;
                            break;
                        }
                    }
                    monthMatch = isAvailableFromMonth;
                }

                return balconyMatch && windowMatch && privatewcMatch && priceMatch && monthMatch;
            });

            displayData(filteredData);
        }

        function resetFilters() {
            document.getElementById('month').value = '';
            document.getElementById('balcony').value = '';
            document.getElementById('window').value = '';
            document.getElementById('privatewc').value = '';
            const maxPriceInput = document.getElementById('maxPrice');
            maxPriceInput.value = parseFloat(maxPriceInput.getAttribute('value')).toFixed(0);
            filteredData = [...allData];
            displayData(filteredData);
        }

        function displayData(dataToShow) {
            const grid = document.getElementById('houseGrid');
            const countElement = document.getElementById('resultsCount');
            grid.innerHTML = '';
            
            const count = dataToShow ? dataToShow.length : 0;
            countElement.textContent = labels[lang].resultsFound.replace('{count}', count);

            if (count === 0) {
                grid.innerHTML = `<div class="text-center p-8 text-gray-500">${labels[lang].noData}</div>`;
                return;
            }

            dataToShow.forEach(item => {
                const photoCell = item.photo && item.photo.trim() !== '' 
                    ? `<a href="${item.photo}" target="_blank" class="text-blue-600 hover:underline font-medium">${labels[lang].viewPhoto}</a>` 
                    : 'N/A';
                const price = item.price && !isNaN(parseFloat(item.price)) && parseFloat(item.price) > 0 
                    ? `€${parseFloat(item.price).toFixed(2)}` 
                    : 'N/A';
                const privatewcDisplay = item.privatewc === 'SIM' ? labels[lang].yes :
                                         item.privatewc === 'NÃO' ? labels[lang].no : 'N/A';
                const balconyDisplay = item.balcony === 'SIM' ? labels[lang].yes :
                                       item.balcony === 'NÃO' ? labels[lang].no : 'N/A';
                const windowDisplay = item.window === 'SIM' ? labels[lang].yes :
                                      item.window === 'NÃO' ? labels[lang].no : 'N/A';
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md';
                card.innerHTML = `
                    <div class="flex flex-col gap-2">
                        <div class="font-medium text-gray-900">${item.house || 'N/A'}</div>
                        <div class="text-sm text-gray-600">${item.address || 'N/A'}</div>
                        <div class="text-sm">${labels[lang].room}${item.room || 'N/A'}</div>
                        <div class="text-sm">${labels[lang].maxGuests}: ${item.maxGuests || 'N/A'}</div>
                        <div class="text-sm">${labels[lang].balcony}: ${balconyDisplay}</div>
                        <div class="text-sm">${labels[lang].window}: ${windowDisplay}</div>
                        <div class="text-sm">${labels[lang].privatewc}: ${privatewcDisplay}</div>
                        <div class="text-sm font-semibold text-green-600">${labels[lang].monthlyStatus}: ${price}</div>
                        <div class="text-sm">${photoCell}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function toggleLanguage(newLang) {
            lang = newLang;
            updateLanguageStyles();
            updateLabelsAndContent();
            displayData(filteredData);
        }

        function updateLanguageStyles() {
            const enBtn = document.getElementById('enBtn');
            const ptBtn = document.getElementById('ptBtn');
            enBtn.textContent = 'English';
            ptBtn.textContent = 'Português';
            enBtn.className = `px-3 py-1 text-sm font-medium rounded-md ${lang === 'en' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
            ptBtn.className = `px-3 py-1 text-sm font-medium rounded-md ${lang === 'pt' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
        }

        function updateLabelsAndContent() {
            const l = labels[lang];
            document.getElementById('mainTitle').textContent = l.mainTitle;
            document.getElementById('monthLabel').textContent = l.monthLabel;
            document.getElementById('balconyLabel').textContent = l.balconyLabel;
            document.getElementById('windowLabel').textContent = l.windowLabel;
            document.getElementById('privatewcLabel').textContent = l.privatewcLabel;
            document.getElementById('priceLabel').textContent = l.priceLabel;
            document.getElementById('filterBtn').textContent = l.filterBtn;
            document.getElementById('resetBtn').textContent = l.resetBtn;
            populateSelects();
        }

        function populateSelects() {
            const l = labels[lang];
            const monthSelect = document.getElementById('month');
            const balconySelect = document.getElementById('balcony');
            const windowSelect = document.getElementById('window');
            const privatewcSelect = document.getElementById('privatewc');
            const currentMonth = monthSelect.value;
            const currentBalcony = balconySelect.value;
            const currentWindow = windowSelect.value;
            const currentPrivatewc = privatewcSelect.value;
            
            monthSelect.innerHTML = `<option value="">${l.any}</option>`;
            Object.keys(l.months).forEach(key => {
                monthSelect.innerHTML += `<option value="${key}">${l.months[key]}</option>`;
            });
            balconySelect.innerHTML = `<option value="">${l.any}</option><option value="SIM">${l.yes}</option><option value="NÃO">${l.no}</option>`;
            windowSelect.innerHTML = `<option value="">${l.any}</option><option value="SIM">${l.yes}</option><option value="NÃO">${l.no}</option>`;
            privatewcSelect.innerHTML = `<option value="">${l.any}</option><option value="SIM">${l.yes}</option><option value="NÃO">${l.no}</option>`;
            
            monthSelect.value = currentMonth;
            balconySelect.value = currentBalcony;
            windowSelect.value = currentWindow;
            privatewcSelect.value = currentPrivatewc;
        }

        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            let bgColor, textColor;
            switch(type) {
                case 'success': bgColor = 'bg-green-100'; textColor = 'text-green-800'; break;
                case 'error': bgColor = 'bg-red-100'; textColor = 'text-red-800'; break;
                default: bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; break;
            }
            messageArea.innerHTML = `<div class="${bgColor} ${textColor} p-4 rounded-md font-medium">${message}</div>`;
        }

        function hideMessage() {
            document.getElementById('messageArea').innerHTML = '';
        }

        window.onload = function() {
            toggleLanguage('en');
            fetchData();
        };
    </script>
</body>
</html>