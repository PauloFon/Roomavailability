<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Availability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        button, select, input {
            transition: all 0.2s ease-in-out;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        @media (max-width: 640px) {
            .filter {
                flex-direction: column;
                gap: 1rem;
            }
            .filter div {
                width: 100%;
            }
        }
        #filterBtn, #resetBtn {
            background-color: #ed2025;
            color: white;
        }
        #filterBtn:hover, #resetBtn:hover {
            background-color: #c9181e;
        }
        #maxPrice:focus {
            outline: none;
            --tw-ring-color: #3b82f6;
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <img src="https://quartoequartos.com/wp-content/uploads/2021/03/logo-sm.jpg" alt="Logo" class="h-20 w-auto rounded-md shadow" />
            <h1 id="mainTitle" class="text-2xl sm:text-3xl font-bold text-gray-800 mt-4 sm:mt-0">Room Availability Filter</h1>
            <div class="lang-toggle mt-4 sm:mt-0">
                <button id="enBtn" onclick="toggleLanguage('en')" class="px-3 py-1 text-sm font-medium rounded-md"></button>
                <button id="ptBtn" onclick="toggleLanguage('pt')" class="px-3 py-1 text-sm font-medium rounded-md"></button>
            </div>
        </div>
        <div class="filter bg-white p-4 rounded-lg shadow-md mb-6">
            <div id="filterLabels" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end">
                <div class="flex flex-col">
                    <label id="monthLabel" for="month" class="text-sm font-medium text-gray-600 mb-1">Show Availabilities From:</label>
                    <select id="month" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </select>
                </div>
                <div class="flex flex-col">
                    <label id="balconyLabel" for="balcony" class="text-sm font-medium text-gray-600 mb-1">Balcony:</label>
                    <select id="balcony" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </select>
                </div>
                <div class="flex flex-col">
                    <label id="windowLabel" for="window" class="text-sm font-medium text-gray-600 mb-1">Window:</label>
                    <select id="window" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </select>
                </div>
                <div class="flex flex-col">
                    <label id="privatewcLabel" for="privatewc" class="text-sm font-medium text-gray-600 mb-1">Private WC:</label>
                    <select id="privatewc" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </select>
                </div>
                <div class="flex flex-col">
                    <label id="priceLabel" for="maxPrice" class="text-sm font-medium text-gray-600 mb-1">Max Price (€):</label>
                    <input type="number" id="maxPrice" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" min="0" step="10" value="1000">
                </div>
                <div class="flex flex-col sm:flex-row gap-2 lg:col-span-1 justify-end mt-4 lg:mt-0">
                    <button id="filterBtn" onclick="filterData()" class="w-full sm:w-auto font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2">Filter</button>
                    <button id="resetBtn" onclick="resetFilters()" class="w-full sm:w-auto font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2">Reset</button>
                </div>
            </div>
        </div>
        
        <div id="resultsCount" class="text-lg font-semibold mb-4 text-gray-700"></div>

        <div id="messageArea" class="my-4"></div>
        <div id="houseGrid" class="card-grid">
        </div>
    </div>

    <!-- Gemini Modal -->
    <div id="geminiModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
                <button onclick="hideModal()" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto">
                <!-- Content will be injected here -->
            </div>
            <div class="p-4 border-t flex justify-end bg-gray-50 rounded-b-lg">
                <button onclick="hideModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let lang = 'en';
        let maxPriceDefault = 1000;

        const academicMonths = ["SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO", "JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO"];

        const labels = {
            en: {
                mainTitle: "Room Availability",
                monthLabel: "Show Availabilities From:",
                balconyLabel: "Balcony:",
                windowLabel: "Window:",
                privatewcLabel: "Private WC:",
                priceLabel: "Max Price (€):",
                filterBtn: "Filter",
                resetBtn: "Reset",
                photos: "Photos",
                house: "House",
                address: "Address",
                room: "Room #",
                maxGuests: "Max Guests",
                balcony: "Balcony",
                window: "Window",
                privatewc: "Private WC",
                monthlyStatus: "Price / Month",
                loading: "Connecting with database...",
                noData: "Sorry! No rooms match your criteria.",
                resultsFound: "Showing {count} total monthly availabilities",
                error: "Error loading data",
                viewPhoto: "View Photo",
                any: "Any",
                yes: "Yes",
                no: "No",
                months: { "SETEMBRO": "September", "OUTUBRO": "October", "NOVEMBRO": "November", "DEZEMBRO": "December", "JANEIRO": "January", "FEVEREIRO": "February", "MARÇO": "March", "ABRIL": "April", "MAIO": "May", "JUNHO": "June", "JULHO": "July" },
                availabilityLabel: "Available in",
                fullAvailabilityLabel: "Full Availability"
            },
            pt: {
                mainTitle: "Disponibilidade de Quartos",
                monthLabel: "Mostrar Disponibilidades De:",
                balconyLabel: "Varanda:",
                windowLabel: "Janela:",
                privatewcLabel: "WC Privado:",
                priceLabel: "Preço Máximo (€):",
                filterBtn: "Filtrar",
                resetBtn: "Repor",
                photos: "Fotos",
                house: "Casa",
                address: "Morada",
                room: "Quarto #",
                maxGuests: "Máx Ocupação",
                balcony: "Varanda",
                window: "Janela",
                privatewc: "WC Privado",
                monthlyStatus: "Preço / Mês",
                loading: "Carregando dados da Folha Google...",
                noData: "Nenhum quarto corresponde aos seus critérios.",
                resultsFound: "Mostrando {count} disponibilidades mensais totais",
                error: "Erro ao carregar dados",
                viewPhoto: "Ver Foto",
                any: "Qualquer",
                yes: "Sim",
                no: "Não",
                months: { "SETEMBRO": "Setembro", "OUTUBRO": "Outubro", "NOVEMBRO": "Novembro", "DEZEMBRO": "Dezembro", "JANEIRO": "Janeiro", "FEVEREIRO": "Fevereiro", "MARÇO": "Março", "ABRIL": "Abril", "MAIO": "Maio", "JUNHO": "Junho", "JULHO": "Julho" },
                availabilityLabel: "Disponível em",
                fullAvailabilityLabel: "Disponibilidade Total"
            }
        };

        function isAvailable(monthValue) {
            const isAvailableString = monthValue === 'Livre';
            const isAvailableNumber = typeof monthValue === 'number' && monthValue > 0;
            const isAvailableStringNumber = typeof monthValue === 'string' && !isNaN(parseFloat(monthValue)) && parseFloat(monthValue) > 0;
            return isAvailableString || isAvailableNumber || isAvailableStringNumber;
        }
        
        function getAvailabilityRange(availability, lang) {
            let startMonth = null;
            let endMonth = null;

            for (const month of academicMonths) {
                if (isAvailable(availability[month])) {
                    if (startMonth === null) {
                        startMonth = month;
                    }
                    endMonth = month;
                } else {
                    if (startMonth !== null) {
                        break; 
                    }
                }
            }

            if (startMonth && endMonth) {
                const start = labels[lang].months[startMonth] || startMonth;
                const end = labels[lang].months[endMonth] || endMonth;
                return start === end ? start : `${start} - ${end}`;
            }
            return 'N/A';
        }


        async function fetchData() {
            const url = 'https://script.google.com/macros/s/AKfycbwL2gJ0mzG7ch6SQzkwZUQ6chQb4kDQEupUEZR2L7iqQozrEkLEclEewqBXC-b25Yai_g/exec';
            showMessage(labels[lang].loading, 'loading');
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Network response was not ok. Status: ${response.status}`);
                }
                const result = await response.json();
                if (result.error) {
                    throw new Error(`Google Script Error: ${result.error}. Details: ${result.details || ''}`);
                }
                allData = result.map(item => {
                    const cleanedAvailability = {};
                    if (item.availability) {
                        for (const key in item.availability) {
                            cleanedAvailability[key.trim().toUpperCase()] = item.availability[key];
                        }
                    }
                    return {
                        ...item,
                        availability: cleanedAvailability,
                        privatewc: item.privatewc ? item.privatewc.toUpperCase() : 'NÃO',
                        balcony: item.balcony ? item.balcony.toUpperCase() : 'NÃO',
                        window: item.window ? item.window.toUpperCase() : 'NÃO',
                        price: item.price ?? null
                    };
                });
                filteredData = [...allData];
                updatePriceRange();
                hideMessage();
                displayData(filteredData);
            } catch (error) {
                console.error('Fetch Error:', error);
                showMessage(`${labels[lang].error}: ${error.message}. Please check the console (F12) for more details.`, 'error');
                document.getElementById('houseGrid').innerHTML = '';
            }
        }

        function updatePriceRange() {
            const maxPriceInput = document.getElementById('maxPrice');
            const maxPrice = allData.reduce((max, item) => {
                const price = parseFloat(item.price);
                return !isNaN(price) && price > max ? price : max;
            }, 0);
            const ceilingPrice = Math.ceil((maxPrice > 0 ? maxPrice : maxPriceDefault) / 10) * 10;
            maxPriceInput.value = ceilingPrice;
            maxPriceInput.max = ceilingPrice;
        }

        function filterData() {
            const balcony = document.getElementById('balcony').value;
            const windowVal = document.getElementById('window').value;
            const privatewc = document.getElementById('privatewc').value;
            const month = document.getElementById('month').value;
            const maxPriceInput = document.getElementById('maxPrice');
            const maxPrice = maxPriceInput.value === '' || isNaN(parseFloat(maxPriceInput.value)) || parseFloat(maxPriceInput.value) < 0 ? Infinity : parseFloat(maxPriceInput.value);

            let monthlyAvailabilities = [];

            const baseFilteredRooms = allData.filter(item => {
                const balconyMatch = balcony === '' || item.balcony === balcony;
                const windowMatch = windowVal === '' || item.window === windowVal;
                const privatewcMatch = privatewc === '' || item.privatewc === privatewc;
                const priceMatch = item.price === null || isNaN(parseFloat(item.price)) || parseFloat(item.price) <= maxPrice;
                return balconyMatch && windowMatch && privatewcMatch && priceMatch;
            });

            if (month === '') {
                 monthlyAvailabilities = baseFilteredRooms.map(room => ({...room, displayMonth: 'Any'}));

            } else {
                const startIndex = academicMonths.indexOf(month);
                if (startIndex !== -1) {
                    for (let i = startIndex; i < academicMonths.length; i++) {
                        const currentMonth = academicMonths[i];
                        baseFilteredRooms.forEach(room => {
                            if (isAvailable(room.availability[currentMonth])) {
                                monthlyAvailabilities.push({ ...room, displayMonth: currentMonth });
                            }
                        });
                    }
                }
            }
            
            displayData(monthlyAvailabilities);
        }

        function resetFilters() {
            document.getElementById('month').value = '';
            document.getElementById('balcony').value = '';
            document.getElementById('window').value = '';
            document.getElementById('privatewc').value = '';
            updatePriceRange(); 
            displayData(allData.map(room => ({...room, displayMonth: 'Any'})));
        }

        function displayData(dataToShow) {
            const grid = document.getElementById('houseGrid');
            const countElement = document.getElementById('resultsCount');
            grid.innerHTML = '';
            
            const count = dataToShow ? dataToShow.length : 0;
            countElement.textContent = labels[lang].resultsFound.replace('{count}', count);

            if (count === 0) {
                grid.innerHTML = `<div class="col-span-full text-center p-8 text-gray-500">${labels[lang].noData}</div>`;
                return;
            }

            dataToShow.forEach(item => {
                const photoCell = item.photo && item.photo.trim() !== '' 
                    ? `<a href="${item.photo}" target="_blank" class="text-blue-600 hover:underline font-medium">${labels[lang].viewPhoto}</a>` 
                    : 'N/A';
                const price = item.price && !isNaN(parseFloat(item.price)) && parseFloat(item.price) > 0 
                    ? `€${parseFloat(item.price).toFixed(2)}` 
                    : 'N/A';
                const privatewcDisplay = item.privatewc === 'SIM' ? labels[lang].yes : labels[lang].no;
                const balconyDisplay = item.balcony === 'SIM' ? labels[lang].yes : labels[lang].no;
                const windowDisplay = item.window === 'SIM' ? labels[lang].yes : labels[lang].no;
                
                const availabilityRange = getAvailabilityRange(item.availability, lang);

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md flex flex-col';
                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="font-bold text-lg text-gray-900">${item.house || 'N/A'} - Room ${item.room || 'N/A'}</div>
                        <div class="text-sm text-gray-600">${item.address || 'N/A'}</div>
                         <div class="text-xs text-gray-500 mt-1">${labels[lang].fullAvailabilityLabel}: ${availabilityRange}</div>
                        <hr class="my-2">
                        <div class="text-sm"><span class="font-medium">${labels[lang].maxGuests}:</span> ${item.maxGuests || 'N/A'}</div>
                        <div class="text-sm"><span class="font-medium">${labels[lang].balcony}:</span> ${balconyDisplay}</div>
                        <div class="text-sm"><span class="font-medium">${labels[lang].window}:</span> ${windowDisplay}</div>
                        <div class="text-sm"><span class="font-medium">${labels[lang].privatewc}:</span> ${privatewcDisplay}</div>
                    </div>
                    <div class="mt-2 pt-2 flex justify-between items-center border-t">
                        <div class="text-lg font-semibold text-green-600">${price}</div>
                        <div class="text-sm">${photoCell}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- Gemini Feature Functions ---

        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('geminiModal').classList.remove('hidden');
            document.getElementById('geminiModal').classList.add('flex');
        }

        function hideModal() {
            document.getElementById('geminiModal').classList.add('hidden');
            document.getElementById('geminiModal').classList.remove('flex');
        }

        function showLoadingModal(title) {
            const loadingSpinner = `
                <div class="flex justify-center items-center h-48">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500"></div>
                </div>
            `;
            showModal(title, loadingSpinner);
        }

        async function callGemini(prompt, retries = 3, delay = 1000) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGemini(prompt, retries - 1, delay * 2);
                    }
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    const safetyReason = candidate?.finishReason;
                    if (safetyReason === 'SAFETY') {
                        return "The response was blocked for safety reasons. Please adjust your request.";
                    }
                    throw new Error("Unexpected API response structure.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return `An error occurred while contacting the AI model: ${error.message}.`;
            }
        }

        async function getNeighborhoodInsights(address) {
            if (!address) {
                showModal("Error", "Address not available for this listing.");
                return;
            }
            showLoadingModal("✨ Generating Neighborhood Insights...");
            
            const prompt = `Provide a brief, helpful summary for a prospective tenant about the neighborhood around "${address}" in Portugal. Focus on the atmosphere, typical amenities like cafes or markets, public transportation options, and the general vibe. Keep it concise (2-3 short paragraphs) and write in a friendly, encouraging tone.`;
            
            const result = await callGemini(prompt);
            showModal("✨ Neighborhood Insights", result.replace(/\n/g, '<br>'));
        }

        async function draftInquiryEmail(item) {
            if (!item || !item.house || !item.room) {
                showModal("Error", "Room details not available for this listing.");
                return;
            }
            showLoadingModal("✨ Drafting Inquiry Email...");

            const priceText = item.price ? ` which I saw listed for €${item.price} per month` : '';
            
            const prompt = `Draft a polite and friendly email in both English and then Portuguese to inquire about renting a room. Address it to "Dear Landlord,". Mention interest in Room #${item.room} at ${item.house}${priceText}. Ask if it's available, about the viewing process, and next steps. Sign off as "A Prospective Tenant". Format the response clearly with headings for "English" and "Portuguese".`;
            
            const result = await callGemini(prompt);
            const formattedResult = `<pre class="whitespace-pre-wrap font-sans text-sm">${result}</pre>`;
            showModal("✨ Draft Inquiry Email", formattedResult);
        }

        // --- Core Application Functions ---

        function toggleLanguage(newLang) {
            lang = newLang;
            updateLanguageStyles();
            updateLabelsAndContent();
            // Re-run the filter with the same criteria to update language on cards
            filterData(); 
        }

        function updateLanguageStyles() {
            const enBtn = document.getElementById('enBtn');
            const ptBtn = document.getElementById('ptBtn');
            enBtn.textContent = 'English';
            ptBtn.textContent = 'Português';
            enBtn.className = `px-3 py-1 text-sm font-medium rounded-md ${lang === 'en' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
            ptBtn.className = `px-3 py-1 text-sm font-medium rounded-md ${lang === 'pt' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
        }

        function updateLabelsAndContent() {
            const l = labels[lang];
            document.title = l.mainTitle;
            document.getElementById('mainTitle').textContent = l.mainTitle;
            document.getElementById('monthLabel').textContent = l.monthLabel;
            document.getElementById('balconyLabel').textContent = l.balconyLabel;
            document.getElementById('windowLabel').textContent = l.windowLabel;
            document.getElementById('privatewcLabel').textContent = l.privatewcLabel;
            document.getElementById('priceLabel').textContent = l.priceLabel;
            document.getElementById('filterBtn').textContent = l.filterBtn;
            document.getElementById('resetBtn').textContent = l.resetBtn;
            populateSelects();
        }

        function populateSelects() {
            const l = labels[lang];
            const monthSelect = document.getElementById('month');
            const balconySelect = document.getElementById('balcony');
            const windowSelect = document.getElementById('window');
            const privatewcSelect = document.getElementById('privatewc');
            
            const currentMonth = monthSelect.value;
            const currentBalcony = balconySelect.value;
            const currentWindow = windowSelect.value;
            const currentPrivatewc = privatewcSelect.value;
            
            monthSelect.innerHTML = `<option value="">${l.any}</option>`;
            academicMonths.forEach(key => {
                if (l.months[key]) {
                    monthSelect.innerHTML += `<option value="${key}">${l.months[key]}</option>`;
                }
            });

            balconySelect.innerHTML = `<option value="">${l.any}</option><option value="SIM">${l.yes}</option><option value="NÃO">${l.no}</option>`;
            windowSelect.innerHTML = `<option value="">${l.any}</option><option value="SIM">${l.yes}</option><option value="NÃO">${l.no}</option>`;
            privatewcSelect.innerHTML = `<option value="">${l.any}</option><option value="SIM">${l.yes}</option><option value="NÃO">${l.no}</option>`;
            
            monthSelect.value = currentMonth;
            balconySelect.value = currentBalcony;
            windowSelect.value = currentWindow;
            privatewcSelect.value = currentPrivatewc;
        }

        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            let bgColor, textColor;
            switch(type) {
                case 'error': 
                    bgColor = 'bg-red-100'; 
                    textColor = 'text-red-800'; 
                    break;
                default: 
                    bgColor = 'bg-blue-100'; 
                    textColor = 'text-blue-800'; 
                    break;
            }
            messageArea.innerHTML = `<div class="${bgColor} ${textColor} p-4 rounded-md font-medium" role="alert">${message}</div>`;
        }

        function hideMessage() {
            document.getElementById('messageArea').innerHTML = '';
        }

        document.addEventListener('DOMContentLoaded', function() {
            toggleLanguage('en');
            fetchData();
        });
    </script>
</body>
</html>


